<!doctype html>
<meta charset=utf-8>
<title>nio.js instance example</title>

<link rel=stylesheet href=../dist/nio.min.css>
<link rel=stylesheet href=example.css>
<script src=../components/lodash/dist/lodash.min.js></script>
<script src=../components/d3/d3.js></script>
<script src=../dist/nio.js></script>

<!-- Bootstrap -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

<h1><span class="icon icon-nio icon-large" title=nio.js></span></h1>
<div class=container>
	<h2>Local Services</h2>
	<pre>Note: you must have a local instance of nio running to use this</pre>

	<br />
	<table id=services class="table table-condensed">
	<thead>
	    <th>Service Name</th> <th>Service Status</th> <th>Action</th>
	</thead>
	<tbody></tbody>
	</table>
</div>

<script>
    // NIO Instance Details
    var nioInstance = nio.instance('127.0.0.1:8181', {
	    user: 'Admin',
	    pass: 'Admin'
	})

    // Call an `action` on a `service` object
    function serviceAction(service, action) {
	nioInstance.serviceStatus(service.name, action)
	    .pipe(nio.transform(function(d) {
		this.push(d.status)
	    }))
	    .pipe(nio.transform(function(status) {
		service.status = status
		render()
	    }))
    }

    function bindServices(services) {
	// Bind some service data to the table, then render
	var rows = d3.select('#services tbody').selectAll('tr').data(services)

	rows.enter().append("tr")
	    .html("<td></td><td>Stopped</td><td>" + 
		"<button action=start type=button class='btn btn-success btn-sm'>Start</button>" + 
		"<button action=stop type=button class='btn btn-danger btn-sm'>Stop</button></td>")

	render()
    }

    // Re-render all the services, based on their data
    function render() {
	var rows = d3.select('#services tbody').selectAll('tr')

	// These set attributes on the table, based on the service data
	rows.classed('success', function(d) { return d.status == 'started' })
	rows.classed('danger', function(d) { return d.status !== 'started' })
	rows.attr('serviceName', function(d) { return d.name })

	rows.select('td:nth-of-type(1)').html(function(d) { return d.name })

	rows.select('td:nth-of-type(2)').html(function(d) {
	    return (d.status == 'started' ? 'Started' : 'Stopped')
	})

	// Listen for button clicks
	rows.selectAll('button').on('click', function(d) {
	    var action = d3.select(d3.event.target).attr('action')
		service = d3.select(d3.event.target.parentNode.parentNode).datum()

	    serviceAction(service, action)
	})
    }

    // Get the list of services from our instance
    nioInstance.services()

	// Convert the hash/object into a list
	.pipe(nio.transform(function(obj) {
	    var out = []
	    for (name in obj) {
		out.push(obj[name])
	    }
	    this.push(out)
	}))

	// bind the resulting list to the table
	.pipe(nio.transform(bindServices))

</script>

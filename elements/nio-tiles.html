<script src=http://54.85.159.254:443/socket.io/socket.io.js></script>
<script src=../components/time-elements/time-elements.js></script>
<script src=../dist/nio.js></script>

<polymer-element name=nio-tiles attributes="min max size sort page">
	<template>
		<link rel=stylesheet href=../dist/nio.min.css>
		<div id=tiles class="tiles has-spacing has-gradient has-overlay has-fixed"></div>
	</template>
	<script>
		Polymer({
			sort: 'time',
			size: 9,
			page: 1,
			observe: {
				sort: 'filter',
				size: 'filter',
				page: 'filter',
				types: 'filter'
			},
			ready: function () {
				var self = this
				this.json = nio.json('http://54.85.159.254')
					.start('posts', {
						sort: this.sort,
						limit: this.size
					})
				this.socketio = nio.socketio('http://54.85.159.254:443').start('default')

				this.collection = nio.collect({
					dupes: 'id',
					sort: this.sort,
					min: this.min,
					max: this.max,
					size: this.size
				})

				this.tiles = nio.tiles(this.$.tiles)

				// combine the streams
				nio.join(
					this.json.pipe(
						nio.pick('posts'),
						nio.map({source: 'json'})
					),
					this.socketio.pipe(
						nio.map({source: 'socketio'})
					)
				).pipe(
					nio.defaults({
						media_url: null,
						profile_image_url: null
					}),
					// instead of passing each object 1 by 1, put them in an array so we can sort them
					this.collection,
					// only update tiles once every second
					nio.throttle(2000),
					// send them to the tiles
					this.tiles
				)
			},
			filter: function (params) {
				console.log('filtering')
				this.socketio.pause()
				this.json.pause()
				this.collection.size(this.size)
				this.collection.sort(this.sort)
				this.collection.clear()
				this.tiles.clear()
				this.json.start('posts', _.assign(params || {}, this.params()))
			},
			reset: function () {
				console.log('reset')
				this.tiles.clear()
				this.collection.clear()
				this.json.start('posts')
				this.socketio.resume()
			},
			// params for JSON requests
			params: function () {
				console.log('getting params')
				return {
					sort: this.sort,
					limit: this.size,
					offset: (this.page - 1) * this.size,
					names: this.names,
					minDate: this.minDate,
					maxDate: this.maxDate
				}
			}
		})
	</script>
</polymer-element>
